sap.ui.define(["FabFinV3/c/BaseController","sap/ui/model/json/JSONModel","FabFinV3/u/formatter","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(t,n,e,r,i,o,a){"use strict";return t.extend("FabFinV3.c.View1",{formatter:e,onInit:function(){this.getOwnerComponent().getRouter().getRoute("home").attachPatternMatched(this._onObjectMatched,this),window.mainsha,window.custsha,this.rCount1=0,this.rCount2=0,this.oModel=new n,this.mModel=new n,this.getView().setModel(this.oModel,"oModel"),this.getView().setModel(this.mModel,"mModel"),this.uModel=new n,this.getView().setModel(this.uModel,"uModel")},_onObjectMatched:function(t){if(window.testRun?(this.custurl="https://api.github.com/repos/britmanjerin/tst/contents/cust.json",this.mainurl="https://api.github.com/repos/britmanjerin/tst/contents/main.json",this.byId("idStopTR").setVisible(!0)):(this.custurl="https://api.github.com/repos/britmanjerin/tst/contents/cust_p.json",this.mainurl="https://api.github.com/repos/britmanjerin/tst/contents/main_p.json",this.byId("idStopTR").setVisible(!1)),!this.headers){var e=this.validateCookie("aKey");if(!e)return void this.onNavLP();this.headers={Authorization:"Bearer "+e,Accept:"application/vnd.github.v3+json","Content-Type":"application/json"}}this.loadCustData(),this.setUModel(),this.onFilterData()},setUModel:function(){var t="A"===this.validateCookie("user").substr(0,1);this.uModel.setData({adm:t}),t||this.getView().getModel("config")&&this.getView().getModel("config").getData().filter||this.byId("idFilter").setSelected(!1)},handleRefresh:function(){setTimeout(function(){this.byId("pullToRefresh").hide(),this.loadCustData()}.bind(this),10)},onPressUser:function(t){this._oPopover&&this._oPopover.destroy(),this._oPopover=sap.ui.xmlfragment("FabFinV3.f.User",this),this.getView().addDependent(this._oPopover),sap.ui.getCore().byId("idUserLogged").setText(this.validateCookie("user")),this._oPopover.openBy(t.getSource())},onLogOut:function(t,e){document.cookie="aKey=; Max-Age=-99999999;",this.headers=!1,e||i.show("Logged out Successfully."),this.onNavLP()},onUserConfig:function(){this._ucDialog&&this._ucDialog.destroy(),this._ucDialog=sap.ui.xmlfragment("FabFinV3.f.UserConfig",this),this.getView().addDependent(this._ucDialog),this._ucDialog.setModel(new n($.extend(!0,{},this.getView().getModel("config").getData())),"ucDialogModel"),this._ucDialog.open()},onFilterData:function(t){var e=[];this.byId("idFilter").getSelected()?e.push(new o("key",a.Contains,"")):(e.push(new o("lnCls",a.NotContains,"X")),e.push(new o("lnRen",a.NotContains,"X"))),this.byId("idList").getBinding("items").filter(e)},loadCustData:function(){var a=this,e=$.Deferred(),s=$.Deferred();sap.ui.core.BusyIndicator.show(0),$.ajax({type:"GET",url:this.custurl,headers:this.headers,cache:!1,success:function(t){if(window.custsha){if(window.custsha!=t.sha)return void(2<a.rCount1?window.location.reload():(a.rCount1++,$.sap.delayedCall(3e3,this,function(){a.loadCustData()})));a.rCount1=0}else window.custsha=t.sha;t=atob(t.content);(t=t.trim()?JSON.parse(t):[]).forEach(function(t){t.lnDt=new Date(t.lnDt).toDateString().split(" ").splice(1,4).join(" "),t.nxtInstsDate&&(t.nxtInstsDate=new Date(t.nxtInstsDate).toDateString().split(" ").splice(1,4).join(" "))}),t.sort((t,e)=>e.key-t.key),a.oModel.setData(t),a.oModel.refresh(),e.resolve()},error:function(t){r.error(t.responseJSON.message),e.resolve()}}),$.ajax({type:"GET",url:this.mainurl,headers:this.headers,cache:!1,success:function(t){if(window.mainsha){if(window.mainsha!=t.sha)return void(2<a.rCount2?window.location.reload():(a.rCount2++,$.sap.delayedCall(3e3,this,function(){a.loadCustData()})));a.rCount2=0}else window.mainsha=t.sha;var e=atob(t.content);(e=e.trim()?JSON.parse(e):{roi:[{month:1,roi:12}],pw:[]}).uc||(e.uc={filter:"",paySchl:"",intRt:"",intRt_c:"",lc:"",ls:"",not:"",reversal:"",bkp:"",frmSes:null,toSes:null}),e.ld=e.ld||12;var i=$.extend(!0,{},e.uc),o=i.frmSes?new Date(Number(i.frmSes)):null,t=i.toSes?new Date(Number(i.toSes)):null;Object.keys(i).forEach(function(t){i[t]="X"==i[t]}),i.frmSes=o,i.toSes=t,i.frmSes=i.frmSes&&new Date(Number(i.frmSes)),i.toSes=i.toSes&&new Date(Number(i.toSes)),sap.ui.getCore().setModel(new n(i),"config"),a.getView().setModel(new n(i),"config"),a.mModel.setData(e),a.mModel.refresh(),s.resolve()},error:function(t){r.error(t.responseJSON.message),s.resolve()}}),$.when(e,s).done(function(){var t,e,i;sap.ui.core.BusyIndicator.hide(),a.uModel.getData().adm||(i=a.getView().getModel("config").getData()).frmSes&&i.toSes&&(e=new Date,t=Number(String(e.getHours())+(String(e.getMinutes()).length<2?"0"+String(e.getMinutes()):String(e.getMinutes()))+(String(e.getSeconds()).length<2?"0"+String(e.getSeconds()):String(e.getSeconds()))),e=Number(String(i.frmSes.getHours())+(String(i.frmSes.getMinutes()).length<2?"0"+String(i.frmSes.getMinutes()):String(i.frmSes.getMinutes()))+(String(i.frmSes.getSeconds()).length<2?"0"+String(i.frmSes.getSeconds()):String(i.frmSes.getSeconds()))),i=Number(String(i.toSes.getHours())+(String(i.toSes.getMinutes()).length<2?"0"+String(i.toSes.getMinutes()):String(i.toSes.getMinutes()))+(String(i.toSes.getSeconds()).length<2?"0"+String(i.toSes.getSeconds()):String(i.toSes.getSeconds()))),(t<e||i<t)&&a.onLogOut(1,1))})},onAddCust:function(t){this._oDialog&&this._oDialog.destroy(),this._oDialog=sap.ui.xmlfragment("FabFinV3.f.AddCust",this),this.getView().addDependent(this._oDialog),t=t||{key:"",refNo:"",name:"",idTyp:"",id:"",mob:"",mail:"",addr:"",type:"",goldGms:"",goldRt:"",lnAmt:"",months:"",roi:this.mModel.getData().roi[0].roi,emi:"",IntAmt:"",compInst:"",ltPay:"",preCls:"",cfAmt:"",lnDt:"",clsDt:"",nxtInsDt:"",payDet:[],roiDet:this.mModel.getData().roi,pwDet:this.mModel.getData().pw,gDet:this.formatter.fillGArr(),crtDt:"",lnCls:"",lnRen:"",lnDur:this.mModel.getData().ld},this._oDialog.setModel(new n($.extend(!0,{},t)),"oDialogModel"),sap.ui.getCore().byId("idLnDt").setMaxDate(new Date),this._oDialog.open()},onAddGoldItems:function(t){this._gDialog&&this._gDialog.destroy(),this._gDialog=sap.ui.xmlfragment("FabFinV3.f.GoldDetail",this),this._oDialog.addDependent(this._gDialog),this._gDialog.openBy(t.getSource())},cAddCust:function(){var t=this._oDialog.getModel("oDialogModel").getData();if(!t.name.trim()||!t.id.trim()||!t.mob.trim()||Number(t.goldGms)<=0||Number(t.lnAmt)<=0)r.error("Please fill all the required fields");else{for(var e=t.gDet.length-1;0<=e;e--)0==Number(t.gDet[e].value)&&t.gDet.splice(e,1);t.goldRt=Number(t.goldRt).toFixed(3),t.key=t.crtDt=t.modDt=Date.now().toString(),delete t.instDet,this.oModel.getData().push(this._oDialog.getModel("oDialogModel").getData());var i=this.oModel.getData(),i=JSON.stringify(i),o=this,a=this.custurl,i={message:"Updating file",content:btoa(i),sha:window.custsha};sap.ui.core.BusyIndicator.show(0),$.ajax({type:"PUT",url:a,headers:o.headers,data:JSON.stringify(i),dataType:"text",success:function(t){window.custsha=JSON.parse(t).content.sha,sap.ui.core.BusyIndicator.hide(),o.loadCustData(),o.onClose(),r.success("Customer Added Successfully.")},error:function(t){r.error("Failed to update.")}})}},calculateEMI:function(t){var e=this._oDialog.getModel("oDialogModel").getData();"G"===t?0<Number(e.goldRt)&&0<Number(e.goldGms)&&(e.lnAmt=Number(e.goldRt)*Number(e.goldGms)):"A"===t&&0<Number(e.lnAmt)&&0<Number(e.goldGms)&&(e.goldRt=Number(e.lnAmt)/Number(e.goldGms)),0<Number(e.lnAmt)&&0<Number(e.roi)&&(e.lnDt=e.lnDt||(new Date).toDateString(),e.payDet=[],this.calPayData(e)),this._oDialog.getModel("oDialogModel").refresh()},calPayData:function(M){M.payDet;var S,y=this.mModel.getData().roi,b=this.mModel.getData().pw;M.instDet=function(t){var e,i,o,a,s=[],n=((new Date).toDateString(),M.lnDur),r=Number(M.lnAmt),l=r,d=new Date(t),g=new Date(t),u=d.getDate(),h=d.getFullYear(),D=d.getMonth()+1,c=(d.getMonth()+1)%12,t=(d.getMonth()+1)%12?d.getFullYear():d.getFullYear()+1,m=5,p=1;for(f in b)if(d.getDate()>=b[f].frm&&d.getDate()<=b[f].to){c=(d.getMonth()+b[f].mc)%12,m=b[f].dt,p=b[f].mc,S=b[f];break}a=new Date(t,c,m),(d.getMonth()+p)%12!=a.getMonth()&&(a=new Date((d.getMonth()+p)%12?d.getFullYear():d.getFullYear()+1,a.getMonth(),0));for(var f=1;f<=n;f++){for(var w in y)if(y[w].month==f){o=Number(y[w].roi)/12/100,Number(y[w].roi);break}e={no:f,prA:r=l,int:Math.round(Number(r)*o+0),lPay:0,payDate:"",amtPaid:0,hist:[]},h=(D%=12)?h:h+1,i={sDt:d,eDt:new Date(h,D,u)},D!=i.eDt.getMonth()&&(i.eDt=new Date(h,i.eDt.getMonth(),0)),i.eDt=new Date(i.eDt.getTime()-864e5),d=new Date(i.eDt.getTime()+864e5),D+=1,e.intFrm=i.sDt.toDateString(),e.intTo=i.eDt.toDateString(),e.fnPayDt=i.eDt.toDateString(),e.instDt=a,e.fnPayDt=(a>=i.eDt?a:i.eDt).toDateString(),a=new Date((a.getMonth()+1)%12?a.getFullYear():a.getFullYear()+1,(a.getMonth()+1)%12,m),(e.instDt.getMonth()+1)%12!=a.getMonth()&&(a=new Date((e.instDt.getMonth()+1)%12?e.instDt.getFullYear():e.instDt.getFullYear()+1,a.getMonth(),0)),e.instStDt=g.toDateString(),g=new Date(new Date(e.fnPayDt).getTime()+864e5),e.intFrm=new Date(e.intFrm),e.intTo=new Date(e.intTo),e.payDate=new Date(e.payDate),e.fnPayDt=new Date(e.fnPayDt),e.instStDt=new Date(e.instStDt),s.push(e)}return s}(M.lnDt),M.pwDet=S?[S]:[]},getNoOfDays:function(t,e){return Math.ceil(Math.abs(e-t)/864e5)+1},onUpdateInt:function(){this._iDialog&&this._iDialog.destroy(),this._iDialog=sap.ui.xmlfragment("idIT","FabFinV3.f.intRate",this),this.getView().addDependent(this._iDialog),this._iDialog.setModel(new n($.extend(!0,[],this.mModel.getData().roi)),"iDialogModel"),this._iDialog.open()},onAddROI:function(){var t=Math.round(sap.ui.getCore().byId("idIT--idMnInp").getValue()),e=sap.ui.getCore().byId("idIT--idRoiInp").getValue();if(t&&e){for(var i=this._iDialog.getModel("iDialogModel").getData(),o={month:t,roi:e,modDt:Date.now().toString()},a=0;a<i.length;a++)if(i[a].month==t){i.splice(a,1,o);break}a==i.length&&i.push(o),i.sort((t,e)=>t.month-e.month),this._iDialog.getModel("iDialogModel").refresh()}},cUpdateInt:function(){var e=this;this.mModel.getData().roi=this._iDialog.getModel("iDialogModel").getData(),this.mModel.getData().modDt=Date.now().toString();var t=JSON.stringify(this.mModel.getData()),i=this.mainurl,t={message:"Updating file",content:btoa(t),sha:window.mainsha};sap.ui.core.BusyIndicator.show(0),$.ajax({type:"PUT",url:i,headers:e.headers,data:JSON.stringify(t),dataType:"text",success:function(t){window.mainsha=JSON.parse(t).content.sha,sap.ui.core.BusyIndicator.hide(),e.loadCustData(),r.success("Updated Successfully.")},error:function(t){r.error("Failed to update.")}}),this.onClose()},onDelIntMonth:function(t){this._iDialog.getModel("iDialogModel").getData().splice(t.getSource().getBindingContext("iDialogModel").getPath().split("/")[1],1),this._iDialog.getModel("iDialogModel").refresh()},onUpdatePW:function(){this._pwDialog&&this._pwDialog.destroy(),this._pwDialog=sap.ui.xmlfragment("FabFinV3.f.PayWindow",this),this.getView().addDependent(this._pwDialog),sap.ui.getCore().byId("idLnDur").setValue(this.mModel.getData().ld),this._pwDialog.setModel(new n($.extend(!0,[],this.mModel.getData().pw)),"pwDialogModel"),this._pwDialog.open()},onAddPW:function(){var t=Math.round(sap.ui.getCore().byId("idFrm").getValue()),e=Math.round(sap.ui.getCore().byId("idTo").getValue()),i=Math.round(sap.ui.getCore().byId("idDt").getValue()),o=Math.round(sap.ui.getCore().byId("idMC").getValue()),e=e||from,o=o||1,i=i||5;if(t){for(var a=this._pwDialog.getModel("pwDialogModel").getData(),s={frm:t,to:e,dt:i,mc:o,modDt:Date.now().toString()},n=0;n<a.length;n++)if(a[n].frm==t&&a[n].to==e){a.splice(n,1,s);break}n==a.length&&a.push(s),this._pwDialog.getModel("pwDialogModel").refresh()}},cUpdatePW:function(){this.mModel.getData().pw=this._pwDialog.getModel("pwDialogModel").getData(),this.mModel.getData().ld=sap.ui.getCore().byId("idLnDur").getValue(),this.mModel.getData().modDt=Date.now().toString();var e=this,t=JSON.stringify(this.mModel.getData()),i=this.mainurl,t={message:"Updating file",content:btoa(t),sha:window.mainsha};sap.ui.core.BusyIndicator.show(0),$.ajax({type:"PUT",url:i,headers:e.headers,data:JSON.stringify(t),dataType:"text",success:function(t){window.mainsha=JSON.parse(t).content.sha,sap.ui.core.BusyIndicator.hide(),e.loadCustData(),r.success("Updated Successfully.")},error:function(t){r.error("Failed to update.")}}),this.onClose()},onDelPW:function(t){this._pwDialog.getModel("pwDialogModel").getData().splice(t.getSource().getBindingContext("pwDialogModel").getPath().split("/")[1],1),this._pwDialog.getModel("pwDialogModel").refresh()},onClose:function(){this._oDialog&&this._oDialog.destroy(),this._iDialog&&(this._iDialog.destroy(),this._iDialog.destroyContent()),this._pwDialog&&this._pwDialog.destroy(),this._ucDialog&&this._ucDialog.destroy()},cUpdateUC:function(){var e=this._ucDialog.getModel("ucDialogModel").getData(),t=e.frmSes?String(e.frmSes.getTime()):"",i=e.toSes?String(e.toSes.getTime()):"";Object.keys(e).forEach(function(t){e[t]=e[t]?"X":""}),e.frmSes=t,e.toSes=i,this.mModel.getData().uc=e,this.mModel.getData().modDt=Date.now().toString();var o=this,t=JSON.stringify(this.mModel.getData()),i=this.mainurl,t={message:"Updating file",content:btoa(t),sha:window.mainsha};sap.ui.core.BusyIndicator.show(0),$.ajax({type:"PUT",url:i,headers:o.headers,data:JSON.stringify(t),dataType:"text",success:function(t){window.mainsha=JSON.parse(t).content.sha,sap.ui.core.BusyIndicator.hide(),o.loadCustData(),r.success("Updated Successfully.")},error:function(t){r.error("Failed to update.")}}),this.onClose()},onBkpFile:function(){var t,e,i;t=this.oModel.getData(),e="Backup",i="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t)),(t=document.createElement("a")).setAttribute("href",i),t.setAttribute("download",e+".json"),document.body.appendChild(t),t.click(),t.remove()},onTestRun:function(t){window.testRun="S"!==t,window.mainsha=null,window.custsha=null,this.byId("idStopTR").setVisible("S"!==t),this.custurl="https://api.github.com/repos/britmanjerin/tst/contents/"+("S"===t?"cust_p":"cust")+".json",this.mainurl="https://api.github.com/repos/britmanjerin/tst/contents/"+("S"===t?"main_p":"main")+".json",this.loadCustData()},onNav:function(t){this.getOwnerComponent().getRouter().navTo("customer",{custId:t.key})},onNavLP:function(t){this.getOwnerComponent().getRouter().navTo("login")}})});
